// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Game {
  id               String            @id @default(cuid())
  roomCode         String            @unique
  status           String            // LOBBY, ROUND1, ROUND2, RESULTS, TOKEN_PLACEMENT, FINAL_PLACEMENT, FINAL_RESULTS, FIRST_MAP_COMPLETED, SECOND_MAP_COMPLETED, FINISHED
  roundNumber      Int               @default(1) // Track multiple game rounds
  winningSong      String?           // A, B, or C - winner for current round (set when entering RESULTS)
  mapType          String?           // "NY" or "CA" - map selection for this game
  mapLayout        String?           // JSON serialized hex positions and types
  totalRounds      Int?              // Calculated based on player count + vertex count
  isPOTS           Boolean           @default(false) // POTS mode: fixed implications, 10 rounds, final placement
  isMultiMap       Boolean           @default(false) // Multi-Map mode: two 18-edge maps, 5 rounds each, NPC tokens
  gameVariant      String?           // Game variant (e.g., "3A" for 3-player NYC15 without NPC)
  currentMapNumber Int               @default(1) // Which map is currently active (1 or 2)
  firstMapLayout   String?           // JSON serialized first map layout
  firstMapResults  String?           // JSON serialized first map symbol results
  secondMapLayout  String?           // JSON serialized second map layout
  turnOrderA       String?           // Turn order for Song A (e.g., "012012") - player indices
  turnOrderB       String?           // Turn order for Song B (e.g., "210021") - player indices
  turnOrderC       String?           // Turn order for Song C (5-6 players only)
  turnOrderD       String?           // Turn order for Song D (4 players only)
  highlightedEdges String?           // JSON array of edge IDs highlighted for current token placement round
  currentTurnIndex Int?              // 0-based index tracking which turn in token placement sequence
  placementTimeout DateTime?         // When current player's token placement turn expires
  players          Player[]
  bids             Bid[]
  influenceTokens  InfluenceToken[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Player {
  id              String            @id @default(cuid())
  gameId          String
  game            Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  name            String
  sessionToken    String            @unique
  currencyBalance Int               @default(30) // Starting currency: 30
  victoryPoints   Int               @default(0) // For lightning hex rewards and final scoring
  isAI            Boolean           @default(false) // True for AI players
  playerColor     String?           // Hex color code assigned at join (e.g., "#FF6B6B")
  cardInventory   String?           // JSON: {"remaining": [1,1,1,1,2,2,2,3,3,4], "spent": []} for 3B variant
  bids            Bid[]
  influenceTokens InfluenceToken[]
  createdAt       DateTime          @default(now())
}

model Bid {
  id            String   @id @default(cuid())
  gameId        String
  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  round         Int      // 1=Promise Phase or 2=Bribe Phase (bidding phase within a game round)
  gameRound     Int      // Overall game round number
  song          String   // "A", "B", "C", or "D"
  amount        Int      // Bid amount in currency (increments of 1)
  promisedCards String?  // JSON: [1,2,3] - Cards promised with this bid (for 3B variant)
  createdAt     DateTime @default(now())
}

model InfluenceToken {
  id          String   @id @default(cuid())
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  roundNumber Int      // Which game round this token was placed
  edgeId      String   // Edge ID between two hexes (e.g., "e_0_0_1_0")
  tokenType   String   // "4/0", "2/2", or "1/3"
  orientation String   // "A" or "B" (which adjacent hex gets higher value)
  createdAt   DateTime @default(now())

  // Note: Removed @@unique([gameId, edgeId]) constraint to support Multi-Map mode
  // where the same edge IDs are reused across different maps (rounds 1-5 vs 6-10).
  // Application code validates no duplicate tokens per edge within the current round.
  @@index([gameId]) // Index for faster queries
  @@index([gameId, edgeId]) // Index for edge lookup performance
}
